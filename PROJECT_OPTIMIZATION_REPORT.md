# 小蓝语音助手：技术改造与优化报告

## 1. 核心模型与组件升级

| 组件 | 修改前 (Before) | 修改后 (After) | 升级收益 |
| :--- | :--- | :--- | :--- |
| **语音识别 (ASR)** | **火山引擎 ASR** / **讯飞流式(IAT)** | **讯飞实时语音转写 (大模型版)** | • **延迟降低 90%** (毫秒级)<br>• **方言支持**: 202种方言免切换<br>• **智能纠错**: 基于大模型上下文理解 |
| **语音合成 (TTS)** | **Edge TTS** (WebSocket) | **火山引擎 TTS** (HTTP版) | • **响应极快**: HTTP直连，无WebSocket握手耗时<br>• **稳定性**: 解决Edge TTS连接不稳的问题<br>• **音质**: 更自然的 Neural 语音 |
| **连接模式** | **短连接** (每句话重连) | **持久连接** (Persistent Connection) | • **0 握手延迟**: 一次连接，全程保持<br>• 彻底消除了每次说话前的"正在连接..."等待 |
| **录音方式** | **VAD 触发录音** (断续) | **常驻录音流** (Stream Queue) | • **不丢首字**: 麦克风一直开着，说话瞬间即被捕获<br>• **无硬件启动延迟** |

---

## 2. 深度体验优化 (UX Improvements)

### ⚡ 极速启动 (Parallel Startup)
*   **优化前**：点击开启 -> 等待播放欢迎语(3秒) -> 播放完才开始连接服务器 -> 用户才能说话。
*   **优化后**：**并行启动**。点击开启 -> **立即**建立连接 & **同时**播放欢迎语 -> 用户**点击即说**，无需等待。

### 🔊 智能回声消除 (Echo Cancellation)
*   **优化前**：机器人播放回复的声音会被麦克风收录，导致机器人自己听到自己说话，无限循环。
*   **优化后**：**智能暂停**。TTS播放开始瞬间**自动暂停**音频发送，播放结束瞬间**自动恢复**。

### 🛡️ 幻听过滤 (Noise Filtering)
*   **优化前**：环境噪音或轻微的"嗯、啊"会被识别成文字并触发回复。
*   **优化后**：**智能过滤**。自动忽略语气词（嗯、哦、呃）和无意义的短噪音（<2字）。

### 🚪 无感关闭 (Async Shutdown)
*   **优化前**：说"退出" -> 界面卡住 -> 等待"再见"播完 -> 才断开连接。
*   **优化后**：**异步关闭**。说"退出" -> **立即**断开连接 & 刷新界面 -> "再见"在后台播放，不阻碍操作。

### 📝 标点符号智能清洗
*   **优化前**：大模型版有时会把上一句的句号放到下一句开头（如 `。退出`）。
*   **优化后**：增加了结果清洗逻辑，自动去除开头的冗余标点（显示为 `退出`）。

### 🧹 磁盘自动清理
*   **优化前**：TTS生成的 `reply_uuid.mp3` 文件会无限堆积。
*   **优化后**：生成新回复前自动扫描并删除旧文件，保持目录整洁。

---

## 3. 代码文件变更概览

1.  **`xfyun_rtasr.py` (新增)**: 
    *   全写的讯飞 **RTASR 大模型版** 客户端。
    *   实现了复杂的 HmacSHA1 鉴权、WebSocket 保活、大模型结果解析。

2.  **`volc_tts_client.py` (新增)**: 
    *   封装了火山引擎 HTTP TTS 客户端。
    *   实现了 `_cleanup_old_files` 自动清理策略。

3.  **`GUI.py` (核心重构)**: 
    *   重构了整个语音循环 (`_voice_loop_async`)，从短连接模式切换为**长连接模式**。
    *   实现了 `threading.Thread` 异步播放逻辑，解决了界面卡顿问题。

4.  **`realtime_asr2.py` (改造)**: 
    *   增加了 `process_chunk_stream_persistent`，支持常驻音频流。
    *   修复了关闭时的 `Event loop is closed` 错误。

---
*Generated by Deepmind Coding Agent*
